Порядок работы с API
================

API Контур.Реестро представляет собой HTTP сервис доступный по адресу /realty/v1/. 

.. toctree::
   :name: method
   :maxdepth: 1
   :caption: Описание методов запроса к  API
   Авторизация <method/auth>
   Создание документооборота <method/docflow>
   Вычитывание новостей <method/news>
   Запрос на описание документооборота <method/postdocflow>
   Отправка документооборот <method/postdocflow>
   Запрос содержимого файла <method/getfile>

На изображении представлен алгоритм работы с API контур Реестро. 
Детльное описание методов представлено ниже.

|image0|_

.. |image0| image:: /img/algoritm.png
.. _image0: https://reestro.kontur.ru/


*************
Авторизация
*************

Для работы с методами API необходимо пройти авторизацию, используя метод :ref:`auth<method/auth>`.

В случае успешной авторизации пользователь может инициировать создание ДО, иначе необходио авторизироваться заново.

*************
Создание документооборота
*************

:ref:`Создание документооборота<method/docflow>` инициализирует процесс работы с документооборотом.
Создание документооборота не отождествляется с его отправкой. 

После его создания, API  Контур.Реестро на основании полученных данных проверяет наличие требований (:ref:`requirements<response/>`)  к данному ДО. 
  
  * в случае их отсутствия ДО становится в очередь на отправку
  * если - определены, то пользователю возвращается детальное описание действий, которые необходимо осуществить для отправки ДО.


*************
Актуализация состояния документооборота
*************

После создания или отправки состояние документооборота может менятся в связи с его обработкой API Контур.Реестро, затем  Росреестром.
Документообороту могут быть присвоены следующие статусы:

    * ``queued``: ожидает отправки
    * ``sent``: отправлен в Росреестр
    * ``suspended``: требуются дополнительные действия 
    * ``completed``: исполнено
    * ``error``: ошибка обработки
    * ``verified``: верификация документооборота

Для получения информации о событиях, по документообороту необходимо периодически: 
  * :ref:`вычитывать новости<method/news>` 
  * :ref:`запрашивать описание документооборота<method/getdocflow>`. 

*************
Подписание
*************

Если после создания документооборота ДО переходит в состояние ``suspend``, то ДО присвоено требование :ref:`signature<response/requirements>`.

  * :ref:`signature<response/requirements>` - требование подписать заявления участниками документооборота. 

.. note::
  ::
   Данное требование возникает до момента отправки ДО в Росреестр, в связи c необходимостью создания электронной версии заявления на регистрационное действие.
 
Для обработки данного требования необходимо :doc:`method/signatures` на каждый файл. 
Когда все документы подписаны можно переходить к отправке ДО.

*************
Отправка документооборота
*************

После подписания заявлений участниками документооборота, необходимо инициировать :ref:`отправку запроса в Росреестр<method/postdocflow>`.

При получении запроса на отправку, он помещается в очередь проверки количества приложенных подписей для каждого документа и их верификации.

.. warning::
  ::
   В случае если подписей недостаточно, либо они не корректны, то будет сгенерировано событие, содержащее описание соответствующей ошибки.

   
*************
*Оплата пошлины*
*************

После успешной отправки ДО запрос поступает в обработку системой Росреестра.
До инициализации обработки заявки сотрудником Росреестра, для заявки начисляются гос. пошлины. 

.. note::
  ::
  Государственная пошлина начисляется за каждое регистрационное действие, которое предусматривает оплату, каждому участнику документооборота инивидуально, учитывая льготы. 

В случае, необходимости оплаты гос. пошлины, документооборот переходит в состояние ``suspend`` и  формируется :ref:`событие payment<response/payment>`, содержащее УИН и сумму для оплаты.

Для продолжения работы с заявкой - необходимо оплатить все начисленные гос. пошлины для данной заявки. Информация об оплате государственной пошлины поступает в Росреестр автоматически в течении суток с момента оплаты.

*************
Обработка результатов
*************

После выполнения всех требований *(при необходимоссти)*, необходимо продолжить процессе актуализации документооборота до получения статуса ``completed``.
Если документооборот в состоянии ``completed``, то ответ будет содержать :ref:`результат обработки<response/result>`.

Чтобы получить результирующие документны, необходимо выпонить :doc:`method/getfile`.

.. note::
   Для каждого типа запроса, результата будет содержать свой набор файлов. 

.. toctree::
   :name: method
   :maxdepth: 1
   :caption: Описание методов запроса к  API
   Авторизация <method/auth>
   Создание документооборота <method/docflow>
   Вычитывание новостей <method/news>
   Добавление подписи на файл <method/signatures>
   Запрос на описание документооборота <method/postdocflow>
   Отправка документооборот <method/postdocflow>
   Запрос содержимого файла <method/getfile>

.. toctree::
   :name: response
   :maxdepth: 1
   :caption: Данные ответов API
   Описание новостей <response/docflowNews>
   Описание документооборота <response/docflowNewsItem>





