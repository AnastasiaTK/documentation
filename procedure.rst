Порядок работы с API
================

.. toctree::
   :name: method
   :maxdepth: 1
   :caption: Описание методов запроса к  API
   Авторизация <method/auth>
   Создание документооборота <method/docflow>
   Вычитывание новостей <method/news>
   Запрос на описание документооборота <method/postdocflow>
   Отправка документооборот <method/postdocflow>
   Запрос содержимого файла <method/getfile>

На изображении представлен алгоритм работы с API контур Реестро. 
Детальное описание методов представлено ниже.

*ДО - документооборот*

 |image0|_

.. |image0| image:: /img/algoritm.png
.. _image0: https://reestro.kontur.ru/

.. Hint::
    Если вы интегрируетесь для отправки **запросов на получение сведений из ЕГРН (выписки)** - вас интересуют только пункты "Авторизация", "Создание документооборота", "Актуализация состояния документооборота", "Обработка результатов". 


*************
Авторизация
*************

Для работы с методами API необходима :doc:`auth`.

В случае успешной авторизации пользователь может инициировать создание ДО, иначе необходимо авторизоваться заново.

*************
Создание документооборота
*************

:doc:`docflow` инициализирует процесс работы API Котнур.Реестро с документооборотом.
Получение ДО API Котнур.Реестро не отождествляется с его отправкой в Росреестр. 

После создания ДО API Контур.Реестро на основании полученных данных проверяет наличие требований (:doc:`requirements<requirements>`)  к данному ДО. 
  
  * в случае их отсутствия  ДО становится в очередь на отправку (HTTP возврата 200);
  * если они определены, то пользователю возвращаются  :doc:`requirements` к документообороту (HTTP возврата 201).

*************
Актуализация состояния документооборота
*************

После создания документооборота, его состояние может измениться в связи с его обработкой API Реестро, затем Росреестром.
Документообороту могут быть присвоены следующие статусы:

    * ``queued``: ожидает отправки
    * ``sent``: отправлен в Росреестр
    * ``suspended``: требуются дополнительные действия 
    * ``completed``: исполнено
    * ``error``: ошибка обработки

Для получения информации о событиях по документообороту необходимо периодически:

  * использовать метод :doc:`news`;
  * использовать метод :doc:`getdocflow`. 

*************
Подписание
*************

Если после того, как вы создали ДО, он переходит в статус ``suspend`` -> ДО присвоено требование :ref:`signature<requirements>`.

  * signature - требование (:doc:`requirements`) подписать заявления участниками документооборота. 

.. note::
       Данное требование возникает до момента отправки ДО в Росреестр, в связи c необходимостью создания электронной версии заявления на регистрационное действие.
 
Для обработки данного требования необходимо осуществить :doc:`signatures` на каждый файл. 
Когда все документы будут подписаны, можно переходить к отправке ДО.

*************
Отправка документооборота
*************

После подписания заявлений участниками документооборота, необходимо использовать метод :doc:`postdocflow`.

При получении запроса на отправку, он помещается в очередь проверки количества приложенных подписей для каждого документа и их верификации.

.. warning::
      В случае, если подписей недостаточно либо они не корректны, то будет сгенерировано событие, содержащее описание соответствующей ошибки.

   
*************
Оплата пошлины
*************

После успешной отправки ДО запрос поступает в обработку системой Росреестра.
Начисление гос. пошлин для заявки происходит до инициализации обработки заявки сотрудником Росреестра.

.. Hint::
    Государственная пошлина начисляется за каждое регистрационное действие, которое предусматривает оплату каждому участнику документооборота индивидуально, учитывая льготы. 

В случае, необходимости оплаты гос. пошлины, документооборот переходит в состояние ``suspend`` и формируется требование (:doc:`requirements`) payment, содержащее УИН и сумму для оплаты.

Для продолжения работы с заявкой - необходимо оплатить все начисленные гос. пошлины для данной заявки. Информация об оплате государственной пошлины поступает в Росреестр автоматически в течении суток с момента оплаты.

*************
Обработка результатов
*************

После выполнения всех требований *(если они были)*, необходимо продолжить процесс актуализации документооборота до получения статуса ``completed``.
Если документооборот в состоянии ``completed``, то ответ будет содержать результат обработки документооборота (:doc:`result`).

Чтобы получить результирующие документы, необходимо выполнить :doc:`getfile`.

.. note::
   Для каждого типа запроса результат будет содержать индивидуальный набор файлов. 

.. toctree::
   :name: method
   :maxdepth: 1
   :caption: Описание методов запроса к  API
   Авторизация <auth>
   Создание документооборота <docflow>
   Вычитывание новостей <news>
   Добавление подписи на файл <signatures>
   Запрос на описание документооборота <postdocflow>
   Отправка документооборот <postdocflow>
   Запрос содержимого файла <getfile>

.. toctree::
   :name: response
   :maxdepth: 1
   :caption: Данные ответов API
   Описание новостей <docflowNews>
   Описание документооборота <docflowNewsItem>






